---
name: Quality Gates

on:
  push:
    branches: [develop, staging]
  pull_request:
    branches: [develop, staging, main]
  workflow_dispatch:
    inputs:
      full_validation:
        description: 'Run full validation regardless of branch'
        type: boolean
        default: false

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # DEVELOP BRANCH - Fast checks only (~2 min)
  # Goal: Quick feedback, don't block iteration
  # =============================================================================
  develop-fast-checks:
    name: Fast Checks (Develop)
    if: |
      (github.ref == 'refs/heads/develop' || github.base_ref == 'develop') &&
      github.event.inputs.full_validation != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: pip install yamllint pyyaml -q

      - name: Python syntax check
        run: python -m compileall scripts/ skills/ -q

      - name: YAML lint workflows
        run: |
          yamllint -d '{extends: default, rules: {line-length: {max: 200}, truthy: disable}}' .github/workflows/

      - name: Validate changed agents only
        run: |
          # Get changed files in this push
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^agents/.*cs-.*\.md$' || true)
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null | grep '^agents/.*cs-.*\.md$' || true)
          fi

          if [[ -n "$CHANGED" ]]; then
            echo "Validating changed agents:"
            echo "$CHANGED"
            echo "$CHANGED" | while read -r agent; do
              if [[ -f "$agent" ]]; then
                python3 scripts/agent_builder.py --validate "$agent"
              fi
            done
          else
            echo "No agent changes detected, skipping validation"
          fi

      - name: Validate changed skills only
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^skills/' | cut -d'/' -f1-3 | sort -u || true)
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null | grep '^skills/' | cut -d'/' -f1-3 | sort -u || true)
          fi

          if [[ -n "$CHANGED" ]]; then
            echo "Validating changed skills:"
            echo "$CHANGED"
            echo "$CHANGED" | while read -r skill; do
              if [[ -d "$skill" ]]; then
                python3 scripts/skill_builder.py --validate "$skill"
              fi
            done
          else
            echo "No skill changes detected, skipping validation"
          fi

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "  DEVELOP - FAST CHECKS PASSED"
          echo "=============================================="
          echo ""
          echo "✓ Python syntax valid"
          echo "✓ YAML workflows valid"
          echo "✓ Changed content validated"
          echo ""
          echo "→ Will auto-promote to staging for full validation"

  # =============================================================================
  # STAGING BRANCH - Full validation (~10 min)
  # Goal: Catch all bugs before production
  # =============================================================================
  staging-full-validation:
    name: Full Validation (Staging)
    if: |
      github.ref == 'refs/heads/staging' ||
      github.base_ref == 'staging' ||
      github.event.inputs.full_validation == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install yamllint pyyaml pytest safety check-jsonschema -q

      - name: Python syntax check
        run: python -m compileall scripts/ skills/ -q

      - name: YAML lint workflows
        run: |
          yamllint -d '{extends: default, rules: {line-length: {max: 200}, truthy: disable}}' .github/workflows/

      - name: Validate workflow schemas
        run: |
          check-jsonschema --builtin-schema github-workflows .github/workflows/*.yml

      - name: Validate ALL agents
        run: |
          echo "=== Validating all 34 agents ==="
          bash scripts/validate_all_agents.sh

      - name: Validate ALL skills
        run: |
          echo "=== Validating all 34 skills ==="
          python3 scripts/validate_all_skills.py

      - name: Validate ALL commands
        run: |
          echo "=== Validating all 16 commands ==="
          python3 scripts/validate_all_commands.py --verbose

      - name: Test Python tools --help
        run: |
          echo "=== Testing 92 Python tool CLI compliance ==="
          FAILED=0
          TOTAL=0
          for tool in $(find skills -name "*.py" -type f); do
            if head -1 "$tool" | grep -q "python"; then
              TOTAL=$((TOTAL + 1))
              if python3 "$tool" --help > /dev/null 2>&1; then
                echo "✓ $tool"
              else
                echo "✗ $tool (--help failed)"
                FAILED=$((FAILED + 1))
              fi
            fi
          done
          echo ""
          echo "Tools: $TOTAL | Passed: $((TOTAL - FAILED)) | Failed: $FAILED"
          if [[ $FAILED -gt 0 ]]; then
            echo "::error::$FAILED Python tools failed --help check"
            exit 1
          fi

      - name: Validate cross-references
        run: |
          echo "=== Validating agent-skill cross-references ==="
          ERRORS=0
          for agent in agents/*/*.md; do
            SKILLS=$(grep -oE '\.\./\.\./skills/[a-z-]+/[a-z-]+[/)]' "$agent" 2>/dev/null | \
                     sed 's|[/)]$||' | sort -u || true)
            for skill_path in $SKILLS; do
              SKILL_DIR=$(echo "$skill_path" | sed 's|\.\./\.\./||')
              if [[ ! -d "$SKILL_DIR" ]]; then
                echo "✗ $agent references non-existent skill: $SKILL_DIR"
                ERRORS=$((ERRORS + 1))
              fi
            done
          done
          if [[ $ERRORS -gt 0 ]]; then
            echo "::error::Found $ERRORS broken cross-references"
            exit 1
          else
            echo "✓ All cross-references valid"
          fi

      - name: Run pytest
        run: |
          if [[ -d "tests" ]]; then
            pytest tests/ -v --tb=short -x
          else
            echo "No tests directory found, skipping"
          fi

      - name: Security scan (advisory)
        continue-on-error: true
        run: |
          if [[ -f requirements.txt ]]; then
            safety check -r requirements.txt --output text || echo "::warning::Security vulnerabilities found"
          fi

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "  STAGING - FULL VALIDATION PASSED"
          echo "=============================================="
          echo ""
          echo "✓ All 34 agents validated"
          echo "✓ All 34 skills validated"
          echo "✓ All 16 commands validated"
          echo "✓ All 92 Python tools CLI-compliant"
          echo "✓ Cross-references verified"
          echo "✓ Tests passed"
          echo ""
          echo "→ Ready for PR to main (production)"

  # =============================================================================
  # MAIN BRANCH - Source verification only
  # Full validation already done on staging
  # =============================================================================
  main-production-gate:
    name: Production Gate (Main)
    if: github.base_ref == 'main'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - uses: actions/checkout@v4

      - name: Verify source branch
        run: |
          SOURCE="${{ github.head_ref }}"
          echo "PR source branch: $SOURCE"
          if [[ "$SOURCE" != "staging" ]]; then
            echo "::error::PRs to main must come from staging branch (got: $SOURCE)"
            echo ""
            echo "Merge to staging first, then create PR from staging → main."
            exit 1
          fi
          echo "✓ Source branch verified: staging"

      - name: Production ready
        run: |
          echo ""
          echo "=============================================="
          echo "  PRODUCTION GATE - READY FOR MERGE"
          echo "=============================================="
          echo ""
          echo "✓ Source: staging (verified)"
          echo "✓ Full validation completed on staging"
          echo ""
          echo "Merge to deploy to production."
