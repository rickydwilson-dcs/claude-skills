---
name: Create PR to Main

on:
  workflow_run:
    workflows: ["Quality Gates"]
    types: [completed]
    branches: [staging]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr-to-main:
    name: Create PR staging â†’ main
    runs-on: ubuntu-latest
    # Only run if Quality Gates passed on staging
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'staging'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check emergency kill switch
        id: killswitch
        run: |
          DISABLED="false"
          if [ -f ".github/WORKFLOW_KILLSWITCH" ]; then
            if grep -q "AUTO_MERGE:.*DISABLED" .github/WORKFLOW_KILLSWITCH; then
              DISABLED="true"
              echo "Auto-merge disabled by kill switch"
            fi
          fi
          echo "auto_merge_disabled=$DISABLED" >> $GITHUB_OUTPUT

      - name: Determine auto-merge status
        id: automerge_config
        run: |
          AUTO_MERGE_ENABLED="${{ vars.AUTO_MERGE_STAGING_TO_MAIN }}"
          KILL_SWITCH="${{ steps.killswitch.outputs.auto_merge_disabled }}"

          if [ "$AUTO_MERGE_ENABLED" == "true" ] && [ "$KILL_SWITCH" != "true" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
            echo "Auto-merge is ENABLED"
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
            echo "Auto-merge is DISABLED (default)"
          fi

      - name: Check if PR needed
        id: check
        run: |
          git fetch origin main staging

          # Get commit SHAs
          STAGING_SHA=$(git rev-parse origin/staging)
          MAIN_SHA=$(git rev-parse origin/main)

          echo "staging: $STAGING_SHA"
          echo "main: $MAIN_SHA"

          # Check if main is behind staging
          if [ "$STAGING_SHA" != "$MAIN_SHA" ]; then
            # Check if staging is ahead of main
            AHEAD=$(git rev-list --count origin/main..origin/staging)
            if [ "$AHEAD" -gt 0 ]; then
              echo "needs_pr=true" >> $GITHUB_OUTPUT
              echo "commits_ahead=$AHEAD" >> $GITHUB_OUTPUT
              echo "Main is $AHEAD commits behind staging - PR needed"
            else
              echo "needs_pr=false" >> $GITHUB_OUTPUT
              echo "No new commits to promote"
            fi
          else
            echo "needs_pr=false" >> $GITHUB_OUTPUT
            echo "Main is up to date with staging"
          fi

      - name: Check for existing PR
        id: existing
        if: steps.check.outputs.needs_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open PR from staging to main
          EXISTING_PR=$(gh pr list --base main --head staging --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "PR #$EXISTING_PR already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Generate PR body
        id: body
        if: steps.check.outputs.needs_pr == 'true' && steps.existing.outputs.exists != 'true'
        run: |
          # Get commit messages since main
          COMMITS=$(git log --oneline origin/main..origin/staging | head -20)
          COMMIT_COUNT=${{ steps.check.outputs.commits_ahead }}

          # Create PR body
          cat << 'EOF' > pr_body.md
          ## Production Release

          This PR promotes validated changes from `staging` to `main`.

          ### Changes Included
          EOF

          echo "\`\`\`" >> pr_body.md
          echo "$COMMITS" >> pr_body.md
          if [ "$COMMIT_COUNT" -gt 20 ]; then
            echo "... and $((COMMIT_COUNT - 20)) more commits" >> pr_body.md
          fi
          echo "\`\`\`" >> pr_body.md

          cat << 'EOF' >> pr_body.md

          ### Validation Status
          - âœ… Quality Gates passed on staging
          - âœ… All agents validated
          - âœ… All skills validated
          - âœ… All commands validated

          ### Deployment
          Merging this PR will deploy to production (main branch).
          EOF

          # Add auto-merge status section
          AUTO_MERGE="${{ steps.automerge_config.outputs.enabled }}"
          if [ "$AUTO_MERGE" == "true" ]; then
            cat << 'EOF' >> pr_body.md

          ### Auto-Merge Status
          **ENABLED** - This PR will auto-merge once all branch protection requirements are met.

          To cancel auto-merge:
          - Run `gh pr merge --disable-auto <PR_NUMBER>`
          - Or close this PR
          - Or create `.github/WORKFLOW_KILLSWITCH` with `AUTO_MERGE: DISABLED`
          EOF
          else
            cat << 'EOF' >> pr_body.md

          ### Merge Required
          Manual merge required. Review and approve, then merge when ready.
          EOF
          fi

          echo "" >> pr_body.md
          echo "---" >> pr_body.md
          echo "ðŸ¤– Auto-generated by CI/CD pipeline" >> pr_body.md

      - name: Create PR
        id: create_pr
        if: steps.check.outputs.needs_pr == 'true' && steps.existing.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base main \
            --head staging \
            --title "Release: Promote staging to main" \
            --body-file pr_body.md)

          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "âœ“ Created PR #$PR_NUMBER for staging â†’ main promotion"

      - name: Enable auto-merge on PR
        if: |
          steps.check.outputs.needs_pr == 'true' &&
          steps.existing.outputs.exists != 'true' &&
          steps.automerge_config.outputs.enabled == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pr_number }}"

          if [ -z "$PR_NUMBER" ]; then
            echo "Warning: No PR number available, cannot enable auto-merge"
            exit 0
          fi

          # Cool-down period for emergency intervention
          DELAY="${{ vars.AUTO_MERGE_DELAY_SECONDS }}"
          DELAY="${DELAY:-60}"

          if [ "$DELAY" -gt 0 ]; then
            echo "Waiting ${DELAY}s before enabling auto-merge (emergency stop window)..."
            sleep "$DELAY"
          fi

          # Verify PR still open (might have been cancelled during delay)
          PR_STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
          if [ "$PR_STATE" != "OPEN" ]; then
            echo "PR #$PR_NUMBER is no longer open ($PR_STATE). Skipping auto-merge."
            exit 0
          fi

          # Enable auto-merge with configured method
          MERGE_METHOD="${{ vars.AUTO_MERGE_METHOD }}"
          MERGE_METHOD="${MERGE_METHOD:-merge}"

          echo "Enabling auto-merge for PR #$PR_NUMBER with method: $MERGE_METHOD"
          gh pr merge "$PR_NUMBER" --auto --"$MERGE_METHOD"

          echo ""
          echo "âœ“ Auto-merge enabled for PR #$PR_NUMBER"
          echo "PR will merge automatically once:"
          echo "  - Required status checks pass"
          echo "  - Required reviews are approved"
          echo "  - All branch protection requirements are met"

      - name: Update existing PR
        if: steps.check.outputs.needs_pr == 'true' && steps.existing.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR #${{ steps.existing.outputs.pr_number }} already exists - no action needed"
          echo "Review and merge at: https://github.com/${{ github.repository }}/pull/${{ steps.existing.outputs.pr_number }}"
