---
name: Create PR to Main

on:
  workflow_run:
    workflows: ["Quality Gates"]
    types: [completed]
    branches: [staging]

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr-to-main:
    name: Create PR staging â†’ main
    runs-on: ubuntu-latest
    # Only run if Quality Gates passed on staging
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'staging'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR needed
        id: check
        run: |
          git fetch origin main staging

          # Get commit SHAs
          STAGING_SHA=$(git rev-parse origin/staging)
          MAIN_SHA=$(git rev-parse origin/main)

          echo "staging: $STAGING_SHA"
          echo "main: $MAIN_SHA"

          # Check if main is behind staging
          if [ "$STAGING_SHA" != "$MAIN_SHA" ]; then
            # Check if staging is ahead of main
            AHEAD=$(git rev-list --count origin/main..origin/staging)
            if [ "$AHEAD" -gt 0 ]; then
              echo "needs_pr=true" >> $GITHUB_OUTPUT
              echo "commits_ahead=$AHEAD" >> $GITHUB_OUTPUT
              echo "Main is $AHEAD commits behind staging - PR needed"
            else
              echo "needs_pr=false" >> $GITHUB_OUTPUT
              echo "No new commits to promote"
            fi
          else
            echo "needs_pr=false" >> $GITHUB_OUTPUT
            echo "Main is up to date with staging"
          fi

      - name: Check for existing PR
        id: existing
        if: steps.check.outputs.needs_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open PR from staging to main
          EXISTING_PR=$(gh pr list --base main --head staging --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "PR #$EXISTING_PR already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Generate PR body
        id: body
        if: steps.check.outputs.needs_pr == 'true' && steps.existing.outputs.exists != 'true'
        run: |
          # Get commit messages since main
          COMMITS=$(git log --oneline origin/main..origin/staging | head -20)
          COMMIT_COUNT=${{ steps.check.outputs.commits_ahead }}

          # Create PR body
          cat << 'EOF' > pr_body.md
          ## Production Release

          This PR promotes validated changes from `staging` to `main`.

          ### Changes Included
          EOF

          echo "\`\`\`" >> pr_body.md
          echo "$COMMITS" >> pr_body.md
          if [ "$COMMIT_COUNT" -gt 20 ]; then
            echo "... and $((COMMIT_COUNT - 20)) more commits" >> pr_body.md
          fi
          echo "\`\`\`" >> pr_body.md

          cat << 'EOF' >> pr_body.md

          ### Validation Status
          - âœ… Quality Gates passed on staging
          - âœ… All agents validated
          - âœ… All skills validated
          - âœ… All commands validated

          ### Deployment
          Merging this PR will deploy to production (main branch).

          ---
          ðŸ¤– Auto-generated by CI/CD pipeline
          EOF

      - name: Create PR
        if: steps.check.outputs.needs_pr == 'true' && steps.existing.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head staging \
            --title "Release: Promote staging to main" \
            --body-file pr_body.md

          echo "âœ“ Created PR for staging â†’ main promotion"

      - name: Update existing PR
        if: steps.check.outputs.needs_pr == 'true' && steps.existing.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR #${{ steps.existing.outputs.pr_number }} already exists - no action needed"
          echo "Review and merge at: https://github.com/${{ github.repository }}/pull/${{ steps.existing.outputs.pr_number }}"
